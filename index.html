<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cybersecurity Training Package</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
        <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #f0f4f8; /* A slightly softer background, less important with video */
                overflow-x: hidden; /* Prevent horizontal scrollbars */
            }
            .hidden {
                display: none;
            }
            .active {
                display: block;
            }

            /* Styles for the background video */
            #background-video {
                position: fixed; /* Fixes the video to the viewport */
                right: 0;
                bottom: 0;
                min-width: 100%;
                min-height: 100%;
                width: auto;
                height: auto;
                z-index: -100; /* Puts it behind all other content */
                filter: brightness(0.7) blur(2px); /* Slightly darken and blur the video for readability */
            }

            /* Custom active tab style */
            .tab.active-tab {
                background-color: #2563eb; /* Blue-700 */
                color: white;
                box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            }

            /* Accordion styles */
            .accordion-header {
                cursor: pointer;
                user-select: none;
            }
            .accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
            }
            .accordion-content.open {
                max-height: 1000px; /* Adjust based on expected content height */
                transition: max-height 0.5s ease-in;
            }

            /* --- New styles for MCQ options (copied and adapted from your example CSS) --- */
            .mcq-option {
                display: flex;
                align-items: center;
                padding: 12px;
                margin-bottom: 8px;
                border: 1px solid #cbd5e1; /* Tailwind's slate-300 */
                border-radius: 0.375rem; /* Tailwind's rounded-md */
                cursor: pointer;
                transition: all 0.2s ease-in-out;
            }

            .mcq-option:hover {
                background-color: #f0f4f8; /* A light grey, similar to gray-50 */
                border-color: #93c5fd; /* Tailwind's blue-300 */
            }

            .mcq-option input[type="radio"] {
                margin-right: 12px;
                /* Hide default radio button, style custom one */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                width: 20px;
                height: 20px;
                border: 2px solid #64748b; /* Tailwind's slate-600 */
                border-radius: 50%;
                outline: none;
                cursor: pointer;
                position: relative;
                flex-shrink: 0; /* Prevent shrinking */
            }

            .mcq-option input[type="radio"]:checked {
                background-color: #3b82f6; /* Tailwind's blue-500 */
                border-color: #3b82f6; /* Tailwind's blue-500 */
            }

            .mcq-option input[type="radio"]:checked::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: white;
            }

            .mcq-option-label {
                font-weight: 500; /* Medium font weight */
                color: #334155; /* Tailwind's slate-700 */
                flex-grow: 1; /* Allows label to take up remaining space */
            }

            /* Highlight selected option's background */
            .mcq-option.selected {
                background-color: #dbeafe; /* Tailwind's blue-100 */
                border-color: #60a5fa; /* Tailwind's blue-400 */
            }
            /* --- End New styles for MCQ options --- */
        </style>
    </head>
    <body class="min-h-screen text-gray-800 p-6 relative">
        <video autoplay muted loop playsinline id="background-video">
            <source src="your-background-video.mp4" type="video/mp4" />
            <source src="your-background-video.webm" type="video/webm" />
            Your browser does not support the video tag.
        </video>

        <div id="auth-section" class="flex justify-center items-center h-screen relative z-10">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
                <div class="flex justify-center mb-6">
                    <img src="securitylogo.png" alt="Company Logo" class="h-24 w-auto object-contain" />
                </div>
                <h2 class="text-3xl font-extrabold mb-6 text-center text-gray-800">Cyber Training</h2>
                <input
                    id="email"
                    type="email"
                    placeholder="Email"
                    class="w-full mb-4 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                />
                <input
                    id="password"
                    type="password"
                    placeholder="Password"
                    class="w-full mb-6 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                />
                <button
                    id="login-btn"
                    class="bg-blue-700 hover:bg-blue-800 text-white w-full py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1"
                >
                    Sign In
                </button>
                <p id="auth-error" class="text-red-600 text-sm mt-3 text-center"></p>
                <p class="text-center mt-4 text-gray-600">
                    Don't have an account?
                    <button id="show-signup" class="text-blue-600 hover:text-blue-800 underline font-medium">
                        Sign Up
                    </button>
                </p>
            </div>
        </div>

        <div id="signup-form" class="hidden flex justify-center items-center h-screen relative z-10">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
                <div class="flex justify-center mb-6">
                    <img src="securitylogo.png" alt="Company Logo" class="h-24 w-auto object-contain" />
                </div>
                <h2 class="text-3xl font-extrabold mb-6 text-center text-gray-800">Create Your Account</h2>
                <input
                    id="signup-name"
                    type="text"
                    placeholder="Full Name"
                    class="w-full mb-4 p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200"
                />
                <input
                    id="signup-email"
                    type="email"
                    placeholder="Student Email"
                    class="w-full mb-4 p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200"
                />
                <div class="mb-4">
                    <label for="signup-degree" class="block text-gray-700 text-sm font-bold mb-2">Select Your Degree:</label>
                    <select
                        id="signup-degree"
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200 text-gray-700 bg-white"
                    >
                        <option value="">-- Choose Your Degree --</option>
                        <option value="Cybersecurity">Cybersecurity</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Business Information Systems">Business Information Systems</option>
                        <option value="Data Science">Data Science</option>
                    </select>
                </div>
                <input
                    id="signup-password"
                    type="password"
                    placeholder="Password"
                    class="w-full mb-6 p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200"
                />
                <button
                    id="signup-btn"
                    class="bg-green-600 hover:bg-green-700 text-white w-full py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1"
                >
                    Register
                </button>
                <p id="signup-error" class="text-red-600 text-sm mt-3 text-center"></p>
                <p class="text-center mt-4 text-gray-600">
                    Already have an account?
                    <button id="back-to-login" class="text-blue-600 hover:text-blue-800 underline font-medium">
                        Back to Login
                    </button>
                </p>
            </div>
        </div>

        <div id="main-app" class="hidden min-h-screen flex flex-col items-center py-8 px-4 relative z-10">
            <header class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-center mb-10 bg-white bg-opacity-90 backdrop-blur-sm rounded-xl p-6 shadow-lg">
                <div class="text-center md:text-left flex-grow mb-4 md:mb-0">
                    <h1 class="text-4xl font-extrabold text-blue-800 leading-tight">
                        Cybersecurity Awareness Training
                    </h1>
                    <p class="text-lg mt-2 text-gray-600">
                        Empowering students with essential knowledge to stay safe online.
                    </p>
                </div>
                <div class="bg-blue-100 text-blue-800 p-4 rounded-lg shadow-inner text-sm md:text-base text-right">
                    <p id="user-name" class="font-bold">Loading User...</p>
                    <p id="user-email" class="text-blue-700"></p>
                    <p id="user-degree" class="text-blue-700"></p> <button id="logout-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold">Log Out</button>
                </div>
            </header>

            <nav class="flex flex-wrap justify-center gap-3 mb-8 w-full max-w-3xl">
                <button class="tab px-6 py-3 bg-blue-100 text-blue-700 font-semibold rounded-full transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-md active-tab" data-target="training">
                    📚 Training Modules
                </button>
                <button class="tab px-6 py-3 bg-blue-100 text-blue-700 font-semibold rounded-full transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-md" data-target="quiz">
                    📝 Quizzes
                </button>
                <button class="tab px-6 py-3 bg-blue-100 text-blue-700 font-semibold rounded-full transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-md" data-target="feedback">
                    🗣️ Survey
                </button>
                <button class="tab px-6 py-3 bg-blue-100 text-blue-700 font-semibold rounded-full transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-md" data-target="report">
                    📊 My Report
                </button>
            </nav>

            <main class="w-full max-w-5xl bg-white bg-opacity-95 backdrop-blur-sm p-8 rounded-xl shadow-2xl animate-fade-in-up">
                <section id="training" class="active">
                    <h2 class="text-3xl font-extrabold mb-6 text-gray-800 border-b-2 pb-3 border-blue-200">
                        Cybersecurity Training Modules
                    </h2>

                    <div id="training-modules-container" class="space-y-4">
                    </div>
                </section>

                <section id="quiz" class="hidden">
                    <h2 class="text-3xl font-extrabold mb-6 text-gray-800 border-b-2 pb-3 border-blue-200">
                        Assess Your Knowledge
                    </h2>

                    <div id="quiz-modules-container" class="space-y-4">
                    </div>

                    <form id="quiz-form" class="hidden mt-6 bg-white p-6 rounded-lg shadow-lg">
                        <div id="quiz-questions"></div>
                        <button
                            type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1 mt-6"
                        >
                            Submit Quiz
                        </button>
                    </form>

                    <div id="quiz-result" class="mt-6 p-4 rounded-lg text-center text-lg font-semibold hidden"></div>
                </section>

                <section id="feedback" class="hidden">
                    <h2 class="text-3xl font-extrabold mb-6 text-gray-800 border-b-2 pb-3 border-blue-200">
                        Share Your Feedback
                    </h2>
                    <form id="feedback-form" class="bg-blue-50 p-6 rounded-lg shadow-inner">
                        <label for="feedback-module" class="block mb-2 font-semibold text-blue-700">Select your module</label>
                        <select id="feedback-module" name="module" class="mb-4 p-3 border border-blue-300 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-700 bg-white">
                            <option value="">-- Select Module --</option>
                            <option value="intro">Module 0: Cybersecurity Essentials</option>
                            <option value="password">Module 1: Strong Passwords</option>
                            <option value="passwordQuiz">Quiz 1: Password Quiz</option>
                            <option value="mfa">Module 2: Multi-Factor Authentication</option>
                            <option value="mfaQuiz">Quiz 2: MFA Quiz</option>
                            <option value="summary">Module 3: Summary</option>
                            <option value="completion">Completion</option>
                        </select>

                        <div class="mb-4">
                            <label for="student-id" class="block mb-2 font-semibold text-blue-700">Indicate your Student ID number <span class="text-red-500">*</span></label>
                            <input
                                type="text"
                                id="student-id"
                                name="studentId"
                                class="w-full p-3 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-700 bg-white"
                                placeholder="e.g., 30000000"
                                required
                            />
                        </div>

                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-blue-700">How likely are you to recommend this training to others? <span class="text-red-500">*</span></label>
                            <div class="flex flex-col sm:flex-row justify-around gap-2">
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="recommend-likelihood" value="1" class="form-radio text-blue-600" required>
                                    <span>1 - Unlikely</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="recommend-likelihood" value="2" class="form-radio text-blue-600">
                                    <span>2 - Neutral</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="recommend-likelihood" value="3" class="form-radio text-blue-600">
                                    <span>3 - Likely</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-blue-700">Rate how difficult it was trying to navigate the training material. <span class="text-red-500">*</span></label>
                            <div class="flex flex-col sm:flex-row justify-around gap-2">
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="navigation-difficulty" value="1" class="form-radio text-blue-600" required>
                                    <span>1 - Difficult</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="navigation-difficulty" value="2" class="form-radio text-blue-600">
                                    <span>2 - Neutral</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="navigation-difficulty" value="3" class="form-radio text-blue-600">
                                    <span>3 - Easy</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-blue-700">Rate how comprehensive the training material is. <span class="text-red-500">*</span></label>
                            <div class="flex flex-col sm:flex-row justify-around gap-2">
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="comprehensiveness-rating" value="1" class="form-radio text-blue-600" required>
                                    <span>1 - Not Comprehensive</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="comprehensiveness-rating" value="2" class="form-radio text-blue-600">
                                    <span>2 - Neutral</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="comprehensiveness-rating" value="3" class="form-radio text-blue-600">
                                    <span>3 - Comprehensive</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-blue-700">Rate how engaging you found the training material. <span class="text-red-500">*</span></label>
                            <div class="flex flex-col sm:flex-row justify-around gap-2">
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="engaging-rating" value="1" class="form-radio text-blue-600" required>
                                    <span>1 - Not engaging</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="engaging-rating" value="2" class="form-radio text-blue-600">
                                    <span>2 - Neutral</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-md hover:bg-blue-100">
                                    <input type="radio" name="engaging-rating" value="3" class="form-radio text-blue-600">
                                    <span>3 - Engaging</span>
                                </label>
                            </div>
                        </div>

                        <label for="feedback-comments" class="block mb-2 font-semibold text-blue-700">In your opinion, what can be done to improve this training?</label>
                        <textarea
                            id="feedback-comments"
                            name="comments"
                            rows="5"
                            class="w-full p-3 border border-blue-300 rounded-md mb-4 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                            placeholder="Your constructive feedback is highly appreciated!"
                        ></textarea>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                            Submit Feedback
                        </button>
                    </form>
                    <div id="feedback-msg" class="mt-4 p-4 rounded-lg text-center text-lg font-semibold bg-green-100 text-green-800 hidden"></div>
                </section>

                <section id="report" class="hidden">
                    <h2 class="text-3xl font-extrabold mb-6 text-gray-800 border-b-2 pb-3 border-blue-200">
                        My Training Report
                    </h2>
                    <div id="report-content" class="bg-blue-50 p-6 rounded-lg shadow-inner text-gray-800 space-y-3">
                        <p class="text-lg"><strong>Name:</strong> <span id="report-name" class="font-medium text-blue-700"></span></p>
                        <p class="text-lg"><strong>Email:</strong> <span id="report-id" class="font-medium text-blue-700"></span></p>
                        <p class="text-lg"><strong>Degree:</strong> <span id="report-degree" class="font-medium text-blue-700"></span></p> <hr class="my-4 border-blue-200" />
                        <h3 class="text-xl font-bold text-blue-800 mb-3">Training Progress</h3>
                        <div id="training-report-details" class="space-y-2">
                            </div>
                        <h3 class="text-xl font-bold text-blue-800 mb-3 mt-4">Quiz Progress</h3>
                        <div id="quiz-report-details" class="space-y-2">
                            </div>
                    </div>
                </section>
            </main>
        </div>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyAdFptKhxHQj9FDbya9lMUw3e1okcp8Kmk",
                authDomain: "cybersecurity-training-a-35bbf.firebaseapp.com",
                projectId: "cybersecurity-training-a-35bbf",
                storageBucket: "cybersecurity-training-a-35bbf.firebasestorage.app",
                messagingSenderId: "1080075020112",
                appId: "1:1080075020112:web:1a2b5a44df03ba6b74ee55",
            };

            firebase.initializeApp(firebaseConfig);

            const auth = firebase.auth();
            const db = firebase.firestore(); // Initialize Firestore

            // Set persistence to 'none' to always require login on page reload
            auth.setPersistence(firebase.auth.Auth.Persistence.NONE)
                .then(() => {
                    console.log("Authentication persistence set to NONE.");
                })
                .catch((error) => {
                    console.error("Error setting persistence:", error);
                });

            let userProgress = {}; // To store video completion and quiz scores
            let currentUserData = {}; // To store additional user data like degree

            const trainingContentOrder = [
                "intro",
                "password",
                "mfa",
                "summary",
                "completion"
            ];

            const allContentModules = {
                intro: { type: "video", title: "Module 0: Cybersecurity Essentials", description: "An overview of key cybersecurity principles and why this training matters.", videoSrc: "intro.mp4", prevModule: null },
                password: { type: "video", title: "Module 1: Strong Passwords", description: "Use long, complex, and unique passwords. Avoid reusing the same password. Consider using a password manager.", videoSrc: "password.mp4", prevModule: "intro" },
                mfa: { type: "video", title: "Module 2: Multi-Factor Authentication", description: "MFA adds an extra layer of security. Even if your password is stolen, the second factor keeps you protected.", videoSrc: "your-mfa-video.mp4", prevModule: "password" },
                summary: { type: "video", title: "Module 3: Summary", description: "A recap of all the key takeaways from this training package.", videoSrc: "summary.mp4", prevModule: "mfa" },
                passwordQuiz: { type: "quiz", title: "Quiz 1: Password Quiz", description: "Test your knowledge on creating strong passwords.", prevModule: "password" },
                mfaQuiz: { type: "quiz", title: "Quiz 2: MFA Quiz", description: "Test your knowledge on Multi-Factor Authentication.", prevModule: "mfa" },
                completion: { type: "completion", title: "Training Completed!", description: "You have successfully completed the Cybersecurity Awareness Training!", prevModule: "summary"}
            };

            const quizData = {
                passwordQuiz: [
                    { question: "What is the main purpose of a password?", options: ["To speed up Browse", "To prove your identity and restrict access", "To back up data", "To store photos"], answer: "To prove your identity and restrict access" },
                    { question: "Which of the following is considered a strong password?", options: ["password123", "iloveyou", "Zebra$R0cks2024", "mynameisjohn"], answer: "Zebra$R0cks2024" },
                    { question: "Why is it not advisable to reuse passwords on different accounts?", options: ["It slows down your phone", "It makes updates harder", "One breach can affect multiple accounts", "It helps websites load faster"], answer: "One breach can affect multiple accounts" },
                    { question: "What is NOT recommended when creating a password?", options: ["Use at least 12 characters", "Include your pet’s name and birthday", "Add numbers and symbols", "Avoid common phrases"], answer: "Include your pet’s name and birthday" },
                    { question: "True or False: It’s okay to write your password on a sticky note near your computer.", options: ["True", "False"], answer: "False" },
                ],
                mfaQuiz: [
                    { question: "Which of the following options best defines Multi-Factor Authentication (MFA)?", options: ["Logging in with just a longer password", "Using multiple passwords for one account", "Verifying identity using two or more different types of security factors", "Logging in from two devices at once"], answer: "Verifying identity using two or more different types of security factors" },
                    { question: "You can set up MFA on most common services like Gmail, Facebook, and student portals.", options: ["True", "False"], answer: "True" },
                    { question: "Why is MFA effective against hackers?", options: ["It blocks access from all devices", "It deletes your password if someone tries to log in", "It requires more than just a password to gain access", "It hides your account from public view"], answer: "It requires more than just a password to gain access" },
                    { question: "Which of the following is NOT a valid MFA factor?", options: ["Something you know (e.g., password)", "Something you have (e.g., authentication token)", "Something you like", "Something you are (e.g., fingerprint)"], answer: "Something you like" },
                    { question: "True or False: Using MFA means you no longer need to create strong passwords.", options: ["True", "False"], answer: "False" },
                ],
            };

            // Function to save user progress (video/quiz completion)
            function saveUserProgress() {
                if (auth.currentUser) {
                    const userId = auth.currentUser.uid;
                    localStorage.setItem(`userProgress_${userId}`, JSON.stringify(userProgress));
                    localStorage.setItem(`userData_${userId}`, JSON.stringify(currentUserData));
                }
            }

            // Function to load user progress and user data from Firestore first, then localStorage as fallback
            async function loadUserProgress() {
                if (auth.currentUser) {
                    const userId = auth.currentUser.uid;

                    try {
                        const doc = await db.collection('users').doc(userId).get();
                        if (doc.exists) {
                            currentUserData = doc.data() || {};
                        } else {
                            currentUserData = {};
                        }
                    } catch (error) {
                        console.error("Error loading user data from Firestore:", error);
                        const savedUserData = localStorage.getItem(`userData_${userId}`);
                        currentUserData = savedUserData ? JSON.parse(savedUserData) : {};
                    }

                    const savedProgress = localStorage.getItem(`userProgress_${userId}`);
                    userProgress = savedProgress ? JSON.parse(savedProgress) : {};
                } else {
                    userProgress = {};
                    currentUserData = {};
                }
            }

            function isModuleCompleted(moduleKey) {
                const module = allContentModules[moduleKey];
                if (!module) return false;

                if (module.type === "video") {
                    return userProgress[moduleKey] && userProgress[moduleKey].watched === true;
                } else if (module.type === "quiz") {
                    return userProgress[moduleKey] && userProgress[moduleKey].score !== undefined && userProgress[moduleKey].score >= 70;
                } else if (module.type === "completion") {
                    const requiredTrainingModules = ["intro", "password", "mfa", "summary"];
                    return requiredTrainingModules.every(key => isModuleCompleted(key));
                } else if (module.type === "quiz_completion") {
                    const requiredQuizzes = ["passwordQuiz", "mfaQuiz"];
                    return requiredQuizzes.every(key => isModuleCompleted(key));
                }
                return false;
            }

            function isModuleLocked(moduleKey) {
                const module = allContentModules[moduleKey];
                if (!module || !module.prevModule) {
                    return false;
                }
                return !isModuleCompleted(module.prevModule);
            }

            function stopAllVideos() {
                document.querySelectorAll("video").forEach((v) => {
                    v.pause();
                    v.currentTime = 0;
                });
            }

            function openAccordion(headerElement) {
                const content = headerElement.nextElementSibling;
                content.classList.add('open');
                content.style.maxHeight = content.scrollHeight + "px";
                headerElement.setAttribute('aria-expanded', 'true');
                headerElement.querySelector('svg:last-child')?.classList.add('rotate-180');
            }

            function closeAccordion(headerElement) {
                const content = headerElement.nextElementSibling;
                content.classList.remove('open');
                content.style.maxHeight = '0';
                headerElement.setAttribute('aria-expanded', 'false');
                headerElement.querySelector('svg:last-child')?.classList.remove('rotate-180');
            }

            function toggleAccordion(headerElement) {
                const content = headerElement.nextElementSibling;
                if (content.classList.contains('open')) {
                    closeAccordion(headerElement);
                } else {
                    document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                        closeAccordion(openContent.previousElementSibling);
                    });
                    openAccordion(headerElement);
                }
            }

            function renderTrainingModules() {
                const container = document.getElementById("training-modules-container");
                container.innerHTML = "";
                const userName = auth.currentUser ? auth.currentUser.displayName : "User";

                trainingContentOrder.forEach(key => {
                    const module = allContentModules[key];
                    const isCompleted = isModuleCompleted(key);
                    const isLocked = isModuleLocked(key);

                    if (module.type === "quiz") return;

                    const accordionBlock = document.createElement("div");
                    accordionBlock.className = "border border-gray-200 rounded-lg overflow-hidden shadow-sm " + (isLocked ? "opacity-60" : "");
                    
                    const header = document.createElement("div");
                    header.className = "accordion-header flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-200";
                    header.setAttribute('role', 'button');
                    header.setAttribute('aria-expanded', 'false');
                    header.setAttribute('aria-controls', `${key}-content`);
                    header.dataset.moduleKey = key;

                    const titleContainer = document.createElement("div");
                    titleContainer.className = "flex items-center gap-3";

                    const checkmarkSvg = `
                        <svg class="w-6 h-6 ${isCompleted ? 'text-green-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    `;
                    titleContainer.innerHTML += checkmarkSvg;

                    const title = document.createElement("h3");
                    title.className = "text-xl font-semibold text-gray-800";
                    title.textContent = module.title;
                    titleContainer.appendChild(title);
                    header.appendChild(titleContainer);

                    const arrowSvg = `
                        <svg class="w-6 h-6 text-gray-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    `;
                    header.innerHTML += arrowSvg;

                    const content = document.createElement("div");
                    content.id = `${key}-content`;
                    content.className = "accordion-content bg-white p-4 sm:p-6";
                    content.setAttribute('aria-labelledby', `${key}-header`);

                    if (module.type === "video") {
                        content.innerHTML = `
                            <p class="mb-4 text-gray-700">${module.description}</p>
                            <div class="aspect-video w-full rounded-lg overflow-hidden shadow-xl mb-4">
                                <video controls class="w-full h-full object-cover" data-module="${key}">
                                    <source src="${module.videoSrc}" type="video/mp4" />
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <button class="mark-watched-btn bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-md font-semibold transition duration-300 ease-in-out transform hover:-translate-y-0.5 w-full ${isCompleted ? 'opacity-50 cursor-not-allowed' : ''}" data-module="${key}" ${isCompleted ? 'disabled' : ''}>
                                ${isCompleted ? '✅ Watched' : 'Mark as Watched'}
                            </button>
                        `;
                    } else if (module.type === "completion") {
                        content.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-2xl font-bold text-green-700 mb-4">🎉 Fantastic work, ${userName}! 🎉</p>
                                <p class="text-lg text-gray-700 mb-4">You have successfully completed all video modules of the Cybersecurity Awareness Training package.</p>
                                <p class="text-lg text-gray-700">You are now better equipped to identify and protect yourself from cyber threats.</p>
                                <p class="text-lg text-gray-700 mt-4">Feel free to proceed to the quizzes or check your report at any time.</p>
                                <img src="badge.png" alt="Completion Badge" class="mx-auto mt-6 w-32 h-32 object-contain">
                            </div>
                        `;
                    }

                    if (isLocked) {
                        header.classList.add("cursor-not-allowed");
                        header.classList.remove("hover:bg-gray-100");
                        header.style.pointerEvents = "none";
                        const lockIcon = `<svg class="w-5 h-5 ml-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>`;
                        titleContainer.innerHTML += lockIcon;
                        accordionBlock.classList.add("filter", "grayscale");
                    } else {
                            header.addEventListener("click", () => {
                                toggleAccordion(header);
                                stopAllVideos();
                                if (module.type === "video") {
                                    const video = content.querySelector('video');
                                    if (video && content.classList.contains('open')) {
                                        video.play();
                                    }
                                }
                            });
                    }

                    accordionBlock.appendChild(header);
                    accordionBlock.appendChild(content);
                    container.appendChild(accordionBlock);
                });

                document.querySelectorAll(".mark-watched-btn").forEach((button) => {
                    button.addEventListener("click", (e) => {
                        const moduleKey = e.target.dataset.module;
                        if (!userProgress[moduleKey]) {
                            userProgress[moduleKey] = {};
                        }
                        userProgress[moduleKey].watched = true;
                        saveUserProgress();
                        renderTrainingModules();
                        renderQuizModules();
                        updateReportContent();
                    });
                });
            }

            function renderQuizModules() {
                const container = document.getElementById("quiz-modules-container");
                container.innerHTML = "";
                quizForm.classList.add("hidden");
                quizResult.classList.add("hidden");
                const userName = auth.currentUser ? auth.currentUser.displayName : "User";

                const quizOrder = ["passwordQuiz", "mfaQuiz", "quiz_completion"];

                if (!allContentModules.quiz_completion) {
                    allContentModules.quiz_completion = {
                        type: "quiz_completion",
                        title: "Quiz Completion!",
                        description: "Congratulations! You've passed all the quizzes!",
                        prevModule: "mfaQuiz"
                    };
                }

                quizOrder.forEach(quizKey => {
                    const module = allContentModules[quizKey];
                    const isCompleted = isModuleCompleted(quizKey);
                    const isLocked = isModuleLocked(quizKey);

                    const accordionBlock = document.createElement("div");
                    accordionBlock.className = "border border-gray-200 rounded-lg overflow-hidden shadow-sm " + (isLocked ? "opacity-60" : "");

                    const header = document.createElement("div");
                    header.className = "accordion-header flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-200";
                    header.setAttribute('role', 'button');
                    header.setAttribute('aria-expanded', 'false');
                    header.setAttribute('aria-controls', `${quizKey}-quiz-content`);
                    
                    const titleContainer = document.createElement("div");
                    titleContainer.className = "flex items-center gap-3";

                    const checkmarkSvg = `
                        <svg class="w-6 h-6 ${isCompleted ? 'text-green-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    `;
                    titleContainer.innerHTML += checkmarkSvg;

                    const title = document.createElement("h3");
                    title.className = "text-xl font-semibold text-gray-800";
                    title.textContent = module.title;
                    titleContainer.appendChild(title);
                    header.appendChild(titleContainer);

                    const arrowSvg = `
                        <svg class="w-6 h-6 text-gray-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    `;
                    header.innerHTML += arrowSvg;

                    const content = document.createElement("div");
                    content.id = `${quizKey}-quiz-content`;
                    content.className = "accordion-content bg-white p-4 sm:p-6";
                    content.setAttribute('aria-labelledby', `${quizKey}-quiz-header`);

                    if (isLocked) {
                        const lockMessage = document.createElement("p");
                        lockMessage.className = "text-red-500 mb-4";
                        lockMessage.textContent = "Complete previous training modules and quizzes to unlock this section.";
                        content.appendChild(lockMessage);
                        header.classList.add("cursor-not-allowed");
                        header.classList.remove("hover:bg-gray-100");
                        header.style.pointerEvents = "none";
                        const lockIcon = `<svg class="w-5 h-5 ml-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>`;
                        titleContainer.innerHTML += lockIcon;
                        accordionBlock.classList.add("filter", "grayscale");
                    } else {
                            header.addEventListener("click", () => {
                                toggleAccordion(header);
                                quizForm.classList.add("hidden");
                                quizResult.classList.add("hidden");
                            });
                    }
                    
                    if (module.type === "quiz") {
                        const quizDescription = document.createElement("p");
                        quizDescription.className = "mb-5 text-gray-700";
                        quizDescription.textContent = module.description;
                        content.appendChild(quizDescription);

                        const startQuizButton = document.createElement("button");
                        startQuizButton.className = "start-quiz-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1";
                        const quizScore = userProgress[quizKey] ? userProgress[quizKey].score : null;
                        startQuizButton.textContent = isCompleted ? `Retake Quiz (Last Score: ${quizScore.toFixed(0)}%)` : "Start Quiz";
                        startQuizButton.dataset.quizTopic = quizKey;
                        startQuizButton.disabled = isLocked;
                        if (isLocked) {
                            startQuizButton.classList.add("opacity-50", "cursor-not-allowed");
                        }
                        startQuizButton.addEventListener("click", () => {
                            loadQuiz(quizKey);
                            document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                                closeAccordion(openContent.previousElementSibling);
                            });
                            quizForm.classList.remove("hidden");
                        });
                        content.appendChild(startQuizButton);

                        const quizFeedbackDiv = document.createElement("div");
                        quizFeedbackDiv.id = `${quizKey}-quiz-feedback`;
                        quizFeedbackDiv.className = `mt-4 p-3 rounded-md text-center text-sm font-medium ${quizScore !== null ? (quizScore >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') : 'hidden'}`;
                        if (quizScore !== null) {
                            quizFeedbackDiv.textContent = `Your last score: ${quizScore.toFixed(0)}% ${quizScore >= 70 ? 'Passed' : 'Failed'}`;
                        }
                        content.appendChild(quizFeedbackDiv);
                    } else if (module.type === "quiz_completion") {
                        content.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-2xl font-bold text-green-700 mb-4">🥳 All Quizzes Completed, ${userName}! 🥳</p>
                                <p class="text-lg text-gray-700 mb-4">You have successfully passed all the quizzes in the Cybersecurity Awareness Training.</p>
                                <p class="text-lg text-gray-700">Your knowledge is strong! Keep up the great work.</p>
                                <img src="badge.png" alt="Quiz Master Badge" class="mx-auto mt-6 w-32 h-32 object-contain">
                            </div>
                        `;
                    }

                    accordionBlock.appendChild(header);
                    accordionBlock.appendChild(content);
                    container.appendChild(accordionBlock);
                });
            }


            const quizQuestionsDiv = document.getElementById("quiz-questions");
            const quizForm = document.getElementById("quiz-form");
            const quizResult = document.getElementById("quiz-result");
            let currentQuizTopic = null;

            function loadQuiz(topic) {
                currentQuizTopic = topic;
                quizQuestionsDiv.innerHTML = "";
                quizResult.innerText = "";
                quizResult.classList.add("hidden");
                quizForm.reset();

                const questions = quizData[topic];
                questions.forEach((q, index) => {
                    const qBlock = document.createElement("div");
                    qBlock.className = "mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50";

                    const questionText = document.createElement("div");
                    questionText.className = "block font-bold mb-3 text-gray-800 text-lg";
                    questionText.innerText = `${index + 1}. ${q.question}`;
                    qBlock.appendChild(questionText);

                    const optionsContainer = document.createElement("div");
                    optionsContainer.className = "space-y-2";

                    q.options.forEach((optionText, optionIndex) => {
                        const optionLabel = document.createElement("label");
                        optionLabel.className = "mcq-option";
                        optionLabel.htmlFor = `q${index}-option${optionIndex}`;

                        const radioInput = document.createElement("input");
                        radioInput.type = "radio";
                        radioInput.name = `q${index}`;
                        radioInput.value = optionText;
                        radioInput.id = `q${index}-option${optionIndex}`;
                        
                        radioInput.addEventListener('change', function() {
                            document.querySelectorAll(`label[for^="q${index}-option"]`).forEach(el => {
                                el.classList.remove('selected');
                            });
                            if (this.checked) {
                                optionLabel.classList.add('selected');
                            }
                        });

                        const optionSpan = document.createElement("span");
                        optionSpan.className = "mcq-option-label";
                        optionSpan.innerText = optionText;

                        optionLabel.appendChild(radioInput);
                        optionLabel.appendChild(optionSpan);
                        optionsContainer.appendChild(optionLabel);
                    });

                    qBlock.appendChild(optionsContainer);
                    quizQuestionsDiv.appendChild(qBlock);
                });

                quizForm.classList.remove("hidden");
            }

            quizForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const selectedTopic = currentQuizTopic;
                const questions = quizData[selectedTopic];
                let score = 0;

                let allAnswered = true;
                for (let i = 0; i < questions.length; i++) {
                    const selectedOption = quizForm.querySelector(`input[name="q${i}"]:checked`);
                    
                    if (!selectedOption) {
                        allAnswered = false;
                        break;
                    }
                    if (selectedOption.value === questions[i].answer) score++;
                }

                if (!allAnswered) {
                    alert("Please answer all questions before submitting the quiz.");
                    return;
                }

                const percentage = (score / questions.length) * 100;

                if (!userProgress[selectedTopic]) {
                    userProgress[selectedTopic] = {};
                }
                userProgress[selectedTopic].score = percentage;
                saveUserProgress();

                quizResult.classList.remove("hidden");
                quizResult.className = "mt-6 p-4 rounded-lg text-center text-lg font-semibold flex flex-col items-center";

                quizResult.querySelectorAll(".quiz-action-btn").forEach(btn => btn.remove());
                quizResult.querySelector("br")?.remove();

                if (percentage >= 70) {
                    quizResult.innerText = `✅ Great job! You scored ${percentage.toFixed(0)}%.`;
                    quizResult.classList.add("bg-green-100", "text-green-800");
                    quizResult.classList.remove("bg-red-100", "text-red-800");

                    const backToQuizzesBtn = document.createElement("button");
                    backToQuizzesBtn.id = "quiz-continue-btn";
                    backToQuizzesBtn.className = "quiz-action-btn mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1";
                    backToQuizzesBtn.textContent = "Back to Quizzes";
                    backToQuizzesBtn.addEventListener("click", () => {
                        quizForm.classList.add("hidden");
                        document.querySelector('.tab[data-target="quiz"]').click();
                        renderTrainingModules();
                        renderQuizModules();
                        updateReportContent();
                    });
                    quizResult.appendChild(backToQuizzesBtn);

                } else {
                    quizResult.innerText = `❌ You scored ${percentage.toFixed(0)}%. Please review the training and try again.`;
                    quizResult.classList.add("bg-red-100", "text-red-800");
                    quizResult.classList.remove("bg-green-100", "text-green-800");

                    const buttonContainer = document.createElement("div");
                    buttonContainer.className = "flex justify-center gap-4 mt-4";

                    const retryBtn = document.createElement("button");
                    retryBtn.className = "quiz-action-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1";
                    retryBtn.textContent = "Retry Quiz";
                    retryBtn.addEventListener("click", () => {
                        loadQuiz(selectedTopic);
                    });

                    const backToTrainingBtn = document.createElement("button");
                    backToTrainingBtn.className = "quiz-action-btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-md font-semibold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1";
                    backToTrainingBtn.textContent = "Go back to Training";
                    backToTrainingBtn.addEventListener("click", () => {
                        quizForm.classList.add("hidden");
                        document.querySelector('.tab[data-target="training"]').click();
                        renderTrainingModules();
                        renderQuizModules();
                        updateReportContent();
                    });

                    buttonContainer.appendChild(retryBtn);
                    buttonContainer.appendChild(backToTrainingBtn);
                    quizResult.appendChild(buttonContainer);
                }
            });


            // Feedback form submission
            document.getElementById("feedback-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const feedbackMsg = document.getElementById("feedback-msg");
                feedbackMsg.classList.add("hidden"); // Hide previous messages

                const module = document.getElementById("feedback-module").value;
                const rating = document.getElementById("feedback-rating").value;
                const studentId = document.getElementById("student-id").value.trim();
                const recommendLikelihood = document.querySelector('input[name="recommend-likelihood"]:checked')?.value;
                const navigationDifficulty = document.querySelector('input[name="navigation-difficulty"]:checked')?.value;
                const comprehensivenessRating = document.querySelector('input[name="comprehensiveness-rating"]:checked')?.value;
                const engagingRating = document.querySelector('input[name="engaging-rating"]:checked')?.value;
                const comments = document.getElementById("feedback-comments").value.trim();

                if (!auth.currentUser) {
                    feedbackMsg.innerText = "Please log in to submit feedback.";
                    feedbackMsg.classList.remove("hidden");
                    feedbackMsg.classList.remove("bg-green-100", "text-green-800");
                    feedbackMsg.classList.add("bg-red-100", "text-red-800");
                    return;
                }

                // Client-side validation for required fields
                if (!studentId || !recommendLikelihood || !navigationDifficulty || !comprehensivenessRating || !engagingRating) {
                    feedbackMsg.innerText = "Please fill in all required survey fields (marked with *).";
                    feedbackMsg.classList.remove("hidden");
                    feedbackMsg.classList.remove("bg-green-100", "text-green-800");
                    feedbackMsg.classList.add("bg-red-100", "text-red-800");
                    return;
                }

                const surveyData = {
                    userId: auth.currentUser.uid,
                    userName: auth.currentUser.displayName || 'Anonymous',
                    userEmail: auth.currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Get server timestamp
                    moduleId: module,
                    moduleRating: rating,
                    studentId: studentId,
                    recommendLikelihood: recommendLikelihood,
                    navigationDifficulty: navigationDifficulty,
                    comprehensivenessRating: comprehensivenessRating,
                    engagingRating: engagingRating,
                    comments: comments,
                    userDegree: currentUserData.degree || 'Not specified' // Include user's degree in survey data
                };

                try {
                    await db.collection("surveys").add(surveyData);

                    // SUCCESS MESSAGE FOR FEEDBACK
                    feedbackMsg.innerText = "Feedback successfully submitted! Thank you for your input.";
                    feedbackMsg.classList.remove("hidden", "bg-red-100", "text-red-800");
                    feedbackMsg.classList.add("bg-green-100", "text-green-800");
                    
                    document.getElementById("feedback-form").reset(); // Clear form after submission
                    document.getElementById("feedback-module").value = ""; // Explicitly reset select
                    document.getElementById("feedback-rating").value = ""; // Explicitly reset select

                } catch (error) {
                    console.error("Error submitting feedback to Firestore:", error);
                    feedbackMsg.innerText = `Error submitting feedback: ${error.message}`;
                    feedbackMsg.classList.remove("hidden", "bg-green-100", "text-green-800");
                    feedbackMsg.classList.add("bg-red-100", "text-red-800");
                }
            });

            function updateReportContent() {
                const reportName = document.getElementById("report-name");
                const reportEmail = document.getElementById("report-id");
                const reportDegree = document.getElementById("report-degree");
                const trainingReportDetails = document.getElementById("training-report-details");
                const quizReportDetails = document.getElementById("quiz-report-details");

                reportName.innerText = auth.currentUser.displayName || "N/A";
                reportEmail.innerText = auth.currentUser.email || "N/A";
                reportDegree.innerText = currentUserData.degree || "Not specified";

                let trainingReportHtml = "";
                trainingContentOrder.forEach(key => {
                    const module = allContentModules[key];
                    if (module.type === "video") {
                        const isCompleted = isModuleCompleted(key);
                        let statusText = isCompleted ? '✅ Completed' : '⏳ Pending';
                        let statusClass = isCompleted ? 'text-green-600' : 'text-gray-500';
                        
                        trainingReportHtml += `
                            <p class="flex justify-between items-center">
                                <span class="font-bold">${module.title}</span>
                                <span class="${statusClass}">
                                    ${statusText}
                                </span>
                            </p>
                        `;
                    }
                });
                trainingReportDetails.innerHTML = trainingReportHtml;


                let quizReportHtml = "";
                const quizKeysForReport = ["passwordQuiz", "mfaQuiz"];
                quizKeysForReport.forEach(quizKey => {
                    const quizTitle = allContentModules[quizKey].title;
                    const quizScore = userProgress[quizKey] ? userProgress[quizKey].score : null;

                    if (quizScore !== null) {
                        quizReportHtml += `<p class="flex justify-between items-center"><span class="font-bold">${quizTitle}</span> <span class="${quizScore >= 70 ? 'text-green-600' : 'text-red-600'}">${quizScore.toFixed(0)}% ${quizScore >= 70 ? '✅ Passed' : '❌ Failed'}</span></p>`;
                    } else {
                        quizReportHtml += `<p class="flex justify-between items-center"><span class="font-bold">${quizTitle}</span> <span class="text-gray-500">Not attempted yet</span></p>`;
                    }
                });
                quizReportDetails.innerHTML = quizReportHtml;
            }


            // Login
            document.getElementById("login-btn").addEventListener("click", async () => {
                const email = document.getElementById("email").value.trim();
                const password = document.getElementById("password").value;

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    document.getElementById("user-name").innerText = user.displayName || "User";
                    document.getElementById("user-email").innerText = user.email;
                    document.getElementById("auth-section").classList.add("hidden");
                    document.getElementById("main-app").classList.remove("hidden");
                    await loadUserProgress();
                    document.getElementById("user-degree").innerText = currentUserData.degree || "Not specified";
                    renderTrainingModules();
                    renderQuizModules();
                    document.querySelector('.tab[data-target="training"]').click();
                } catch (error) {
                    document.getElementById("auth-error").innerText = error.message;
                    console.error("Login Error:", error);
                }
            });

            // Logout functionality
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", () => {
                    auth.signOut()
                        .then(() => {
                            document.getElementById("user-name").innerText = "";
                            document.getElementById("user-email").innerText = "";
                            document.getElementById("user-degree").innerText = "";
                            document.getElementById("main-app").classList.add("hidden");
                            document.getElementById("auth-section").classList.remove("hidden");
                            userProgress = {};
                            currentUserData = {};
                            localStorage.removeItem(`userProgress_${auth.currentUser?.uid}`);
                            localStorage.removeItem(`userData_${auth.currentUser?.uid}`);
                            stopAllVideos();
                        })
                        .catch((error) => {
                            console.error("Logout Error:", error.message);
                        });
                });
            }


            // Switch to Sign Up
            document.getElementById("show-signup").addEventListener("click", () => {
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("signup-form").classList.remove("hidden");
            });

            // Back to Login
            document.getElementById("back-to-login").addEventListener("click", () => {
                document.getElementById("signup-form").classList.add("hidden");
                document.getElementById("auth-section").classList.remove("hidden");
            });

            // Sign Up
            document.getElementById("signup-btn").addEventListener("click", async () => {
                const email = document.getElementById("signup-email").value.trim();
                const password = document.getElementById("signup-password").value;
                const name = document.getElementById("signup-name").value.trim();
                const degree = document.getElementById("signup-degree").value;

                if (!email.endsWith("@student.murdoch.edu.au")) {
                    document.getElementById("signup-error").innerText = "Only Murdoch student emails are allowed.";
                    return;
                }

                if (!name) {
                    document.getElementById("signup-error").innerText = "Please enter your full name.";
                    return;
                }

                if (!degree) {
                    document.getElementById("signup-error").innerText = "Please select your degree.";
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    await user.updateProfile({ displayName: name });

                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        displayName: name,
                        degree: degree
                    }, { merge: true });

                    currentUserData = {
                        email: user.email,
                        displayName: user.displayName,
                        degree: degree
                    };
                    saveUserProgress();

                    document.getElementById("user-name").innerText = user.displayName || "User";
                    document.getElementById("user-email").innerText = user.email;
                    document.getElementById("user-degree").innerText = currentUserData.degree;
                    document.getElementById("signup-form").classList.add("hidden");
                    document.getElementById("main-app").classList.remove("hidden");
                    await loadUserProgress();
                    renderTrainingModules();
                    renderQuizModules();
                    document.querySelector('.tab[data-target="training"]').click();
                } catch (error) {
                    document.getElementById("signup-error").innerText = error.message;
                    console.error("Signup Error:", error);
                }
            });

            // Tab switching logic
            document.querySelectorAll(".tab").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const target = btn.dataset.target;

                    stopAllVideos();
                    document.querySelectorAll("section").forEach((sec) => sec.classList.add("hidden"));
                    document.getElementById(target).classList.remove("hidden");

                    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active-tab"));
                    btn.classList.add("active-tab");

                    if (target === "quiz") {
                        renderQuizModules();
                    } else {
                        quizForm.classList.add("hidden");
                        quizResult.classList.add("hidden");
                    }

                    if (target === "report") {
                        updateReportContent();
                    }

                    if (target === "feedback") {
                        document.getElementById("feedback-msg").classList.add("hidden");
                        document.getElementById("feedback-form").reset();
                        document.getElementById("feedback-module").value = "";
                        document.getElementById("feedback-rating").value = "";
                    }
                });
            });


            // Initial setup on page load
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.getElementById("user-name").innerText = user.displayName || "User";
                    document.getElementById("user-email").innerText = user.email;
                    document.getElementById("auth-section").classList.add("hidden");
                    document.getElementById("main-app").classList.remove("hidden");
                    await loadUserProgress();
                    document.getElementById("user-degree").innerText = currentUserData.degree || "Not specified";
                    renderTrainingModules();
                    renderQuizModules();
                    document.querySelector('.tab[data-target="training"]').click();
                } else {
                    document.getElementById("auth-section").classList.remove("hidden");
                    document.getElementById("main-app").classList.add("hidden");
                }
            });
        </script>
    </body>
</html>
